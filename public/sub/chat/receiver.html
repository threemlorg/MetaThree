<!DOCTYPE html>
<html lang="en">
<head>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js" crossorigin="anonymous"></script>
 <title>Receiver</title>
 <style>
     body{
         font-family: Arial, Helvetica, sans-serif;
         background-color: aliceblue;
         height: 100vh;
         width: 100vw;
         font-size: xx-large;
     }
     input{
        font-size: xx-large;
         
     }
     .rowitem{
         display: flex;
     }
     .label{
         display:inline-block;
         width: 300px;
     }
     .field{
         display:inline-block;
     }
     .search{
         width: 700px;
         height: 100px;
         font-size: xx-large;
     }
     .commonMsg{
         color: cadetblue;
         margin-top: 30px;;
     }
     .error{
         color: red;
     }
     .hide{
         display: none;
     }
     .msg{
         overflow-y: auto;
         max-height: 650px;
         width: 1200px;
     }
     .users{
         color:green;
     }
 </style>
</head>
<body>
 <h1>Leave your remarks</h1>
 <div class="users" id="users"></div>
 <div id="nicknamerow" class="rowitem">
    <div class="label">Your nickname:</div>
    <div class="field"><input type="text" id="username" maxlength="20"></div>
</div>
<div id="commonMsg" class="commonMsg"></div>
<div class="rowitem">
    <div class="label">Message:</div>
    <div class="field"><textarea class="search" maxlength="250" type="search" id="message" ></textarea>    
   <input type="button" value="send" onclick="sendMessage()"></div>
</div>

 <div id="msgBox" class="msg">

 </div>

 <script>
 const msgBox = document.getElementById("msgBox")
 const usersDiv=document.getElementById("users");
 const socket = io.connect();
 socket.on('connect', function() {
   // Connected, let's sign-up for to receive messages for this room
   socket.emit('room', getRelativeUrl());


socket.on("new-chat",(chatarr)=>{
    addChats(chatarr);
   });

 socket.on("new-data",(chatarr)=>{
    msgBox.innerHTML='';
    addChats(chatarr);
 });
 socket.on("usersList", (ul)=>{
     if(ul.length>0){
        var users=ul.join(', ');
        usersDiv.innerHTML='Current visitors: '+users;
     }
     else{
        usersDiv.innerHTML='';
     }
 })
});
 function getRelativeUrl(){
    var loc = new URL(window.top.location.href); //get the current location
    var rel = loc.pathname; //relative link from dir to loc
    return rel;
}
function addChats(chatarr){
    for(var i=0;i<chatarr.length;i++){
        var chat=chatarr[i];
        var txt=`${chat.d} (${chat.u}): ${chat.m}`;
        msgBox.innerHTML = (txt + "<br/>")+ msgBox.innerHTML;
    }
}
function sendMessage(){
    var n=document.getElementById('username');
    var e=document.getElementById('commonMsg');
    var nn=document.getElementById('nicknamerow');
    var m=document.getElementById('message');
     if(!n || n.value.length==0)
    {
        e.innerHTML='Please provide a nickname';
        e.classList.add('error');
    }
    else{
        e.innerHTML='';//`Welcome to the chatbox, ${n.value}`;
        e.classList.remove('error');
        nn.classList.add('hide')
        var m=document.getElementById('message');

        if(m.value && m.value.length>0){
            var j={
                'm':m.value,
                'u':n.value, 
                'r':getRelativeUrl()
            }
            socket.emit('message',j);
            m.value='';
            m.focus();
       }
    }
}

 </script>
</body>
</html>